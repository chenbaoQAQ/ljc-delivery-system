<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è€ä¹¡é¸¡é…é€å®¡è®¡çœ‹æ¿</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f7f9; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 100%; }
        .tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #7f8c8d; }
        .tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .stat-bar { display: flex; gap: 25px; margin-bottom: 15px; padding: 12px 20px; background: #fff; border-radius: 8px; border-left: 5px solid #3498db; }
        .stat-item { display: flex; align-items: center; gap: 8px; font-size: 14px; font-weight: bold; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; color: #fff; font-weight: bold; }
        .btn-blue { background: #3498db; } .btn-red { background: #e74c3c; } .btn-green { background: #2ecc71; } .btn-cyan { background: #00bcd4; } .btn-orange { background: #e67e22; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #edf2f7; padding: 8px; text-align: center; white-space: nowrap; }
        th { background: #f7fafc; position: sticky; top: 0; z-index: 10; }
        .shop-col { position: sticky; left: 0; background: #fff; font-weight: bold; z-index: 11; border-right: 2px solid #3498db; }
        .cell-error { background-color: #fff1f0 !important; color: #cf1322 !important; font-weight: bold; border: 1px solid #ffa39e !important; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; }
    </style>
</head>
<body>
<div id="loading-overlay"><div><p>ğŸš€ æ­£åœ¨å¤„ç†ä¸­...</p></div></div>
<div class="card">
    <div class="tabs">
        <button class="tab-btn active" id="tab-audit" onclick="switchTab('audit')">ğŸ” å®¡è®¡çœ‹æ¿</button>
        <button class="tab-btn" id="tab-manage" onclick="switchTab('manage')">âš™ï¸ åº•æ¿ç®¡ç†</button>
    </div>

    <div id="page-audit">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="ym" value="2024-03" style="width:100px">
            <button class="btn btn-blue" onclick="loadData('report')">ğŸ” æ•°æ®å®¡è®¡</button>
            <button class="btn btn-red" onclick="loadData('exception')">ğŸ”´ å¼‚å¸¸æ¸…å•</button>
            <button class="btn btn-cyan" onclick="exportQualifiedList()">ğŸ“¥ å¯¼å‡ºåˆæ ¼æ˜ç»† (åˆ—è¡¨)</button>
            <button class="btn btn-orange" onclick="exportExceptionMatrix()">ğŸ“¥ å¯¼å‡ºå¼‚å¸¸é—¨åº— (å¤§è¡¨)</button>
            <div style="flex-grow: 1;"></div>
            <input type="file" id="csv-file">
            <button class="btn btn-green" onclick="uploadCsv()">å¯¼å…¥æ•°æ®</button>
        </div>
        <div class="stat-bar">
            <div class="stat-item">æ€»é—¨åº—æ•°: <span id="stat-total">-</span></div>
            <div class="stat-item">âœ… åˆæ ¼é—¨åº—: <span id="stat-ok" style="color:#2ecc71">-</span></div>
            <div class="stat-item">âŒ å¼‚å¸¸é—¨åº—: <span id="stat-err" style="color:#e74c3c">-</span></div>
        </div>
        <div id="wrapper-audit" style="overflow: auto; max-height: 60vh; border: 1px solid #eee;"></div>
        <div id="pager" style="text-align:center; margin-top:15px; display:none;">
            <button class="btn btn-blue" onclick="changePage(-1)">ä¸Šä¸€é¡µ</button>
            <span id="page-info" style="margin: 0 15px; font-weight: bold;"></span>
            <button class="btn btn-blue" onclick="changePage(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div id="page-manage" style="display:none;">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="m_ym" value="2024-03" onchange="loadTemplates()">
            <button class="btn btn-blue" onclick="initEditor()">+ å½•å…¥æ–°åº•æ¿</button>
        </div>
        <div id="template-list"></div>
        <div id="editor" style="display:none; border:2px solid #3498db; padding:20px; border-radius:8px; margin-top:10px;">
            <h3 id="ed-title">åº•æ¿å½•å…¥</h3>
            <input type="hidden" id="ed-id">
            åç§°: <input type="text" id="ed-name" style="width:200px; padding:5px;">
            <div id="day-inputs" style="display:grid; grid-template-columns: repeat(11, 1fr); gap:10px; margin:15px 0;"></div>
            <button class="btn btn-blue" onclick="saveTemplate()">ä¿å­˜</button>
            <button class="btn btn-red" onclick="document.getElementById('editor').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8181/api/status';
    let curP = 1, totalP = 1;

    const toggleLoader = (s) => document.getElementById('loading-overlay').style.display = s ? 'flex' : 'none';

    function switchTab(t) {
        document.getElementById('page-audit').style.display = t === 'audit' ? 'block' : 'none';
        document.getElementById('page-manage').style.display = t === 'manage' ? 'block' : 'none';
        document.getElementById('tab-audit').classList.toggle('active', t === 'audit');
        document.getElementById('tab-manage').classList.toggle('active', t === 'manage');
        if(t === 'manage') loadTemplates();
    }

    // å¯¼å‡ºåˆæ ¼é—¨åº— (åˆ—è¡¨æ ¼å¼)
    function exportQualifiedList() {
        window.location.href = `${API}/export-qualified-list?ym=${document.getElementById('ym').value}`;
    }

    // å¯¼å‡ºå¼‚å¸¸é—¨åº— (å¤§è¡¨çŸ©é˜µæ ¼å¼)
    function exportExceptionMatrix() {
        window.location.href = `${API}/export-exception-matrix?ym=${document.getElementById('ym').value}`;
    }

    function renderMatrix(data) {
        const wrap = document.getElementById('wrapper-audit');
        if (!data.records?.length) return wrap.innerHTML = "<p style='padding:20px; text-align:center;'>æ— é…é€æ•°æ®</p>";
        let h = `<table><thead><tr><th class="shop-col">é—¨åº—ID</th><th>åº•æ¿</th>`;
        for(let d=1; d<=data.days; d++) h += `<th>${d}</th>`;
        h += `</tr></thead><tbody>`;
        data.records.forEach(r => {
            h += `<tr><td class="shop-col">${r.shopId}</td><td style="color:#e67e22; font-weight:bold">${r.bestTemplate}</td>`;
            for(let d=1; d<=data.days; d++) h += `<td class="${r['isError'+d]?'cell-error':''}">${r['day'+d]}</td>`;
            h += `</tr>`;
        });
        wrap.innerHTML = h + `</tbody></table>`;
    }

    async function loadData(mode) {
        toggleLoader(true);
        const ym = document.getElementById('ym').value;
        const url = mode === 'report' ? `${API}/auto-report?ym=${ym}&current=${curP}` : `${API}/exception-matrix?ym=${ym}`;
        try {
            const d = await (await fetch(url)).json();
            renderMatrix(d);
            const pager = document.getElementById('pager');
            if(mode === 'report') {
                pager.style.display = 'block'; totalP = d.pages;
                document.getElementById('page-info').innerText = `ç¬¬ ${d.current} / ${d.pages} é¡µ`;
                document.getElementById('stat-total').innerText = d.total || 0;
                document.getElementById('stat-ok').innerText = d.qualifiedCount || 0;
                document.getElementById('stat-err').innerText = d.abnormalCount || 0;
            } else { pager.style.display = 'none'; }
        } catch(e) { console.error(e); }
        toggleLoader(false);
    }

    async function loadTemplates() {
        const ym = document.getElementById('m_ym').value;
        const list = await (await fetch(`${API}/templates?ym=${ym}`)).json();
        let h = `<table><thead><tr><th>åº•æ¿åç§°</th><th>æ“ä½œ</th></tr></thead><tbody>`;
        list.forEach(t => h += `<tr><td>${t.templateName}</td><td><button onclick='editT(${JSON.stringify(t)})'>ç¼–è¾‘</button> <button onclick='delT(${t.id})'>åˆ é™¤</button></td></tr>`);
        document.getElementById('template-list').innerHTML = h + `</tbody></table>`;
    }

    function initEditor() {
        document.getElementById('editor').style.display = 'block';
        document.getElementById('ed-id').value = ''; document.getElementById('ed-name').value = '';
        renderDays();
    }

    function renderDays(cfg = null) {
        const ym = document.getElementById('m_ym').value;
        const parts = ym.split('-');
        const days = new Date(parts[0], parts[1], 0).getDate();
        let h = '';
        const configArr = cfg ? cfg : [];
        for(let i=1; i<=days; i++) h += `<div>${i}<br><input type='text' class='d-v' style='width:25px; text-align:center;' value='${configArr[i-1] || 0}'></div>`;
        document.getElementById('day-inputs').innerHTML = h;
    }

    function editT(t) {
        document.getElementById('editor').style.display = 'block';
        document.getElementById('ed-id').value = t.id; document.getElementById('ed-name').value = t.templateName;
        renderDays(t.config.split(','));
    }

    async function saveTemplate() {
        const body = {
            id: document.getElementById('ed-id').value || null,
            templateName: document.getElementById('ed-name').value,
            yearMonth: document.getElementById('m_ym').value,
            config: Array.from(document.querySelectorAll('.d-v')).map(i => i.value).join(',')
        };
        await fetch(`${API}/template`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        document.getElementById('editor').style.display = 'none'; loadTemplates();
    }

    async function delT(id) {
        if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { await fetch(`${API}/template/${id}`, { method:'DELETE' }); loadTemplates(); }
    }

    const changePage = (s) => { if(curP+s > 0 && curP+s <= totalP) { curP+=s; loadData('report'); } }

    async function uploadCsv() {
        const fd = new FormData();
        fd.append("file", document.getElementById('csv-file').files[0]);
        fd.append("ym", document.getElementById('ym').value);
        toggleLoader(true);
        await fetch(`${API}/upload-csv`, { method: 'POST', body: fd });
        toggleLoader(false); loadData('report');
    }

    window.onload = () => loadData('report');
</script>
</body>
</html>