<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è€ä¹¡é¸¡é…é€å®¡è®¡çœ‹æ¿ - å…¨åŠŸèƒ½æ•´åˆç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f7f9; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 100%; overflow-x: auto;}
        .tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #7f8c8d; }
        .tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
        .toolbar { display: flex; gap: 10px; margin-bottom: 15px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; color: #fff; font-weight: bold; }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-orange { background: #e67e22; }
        .btn-purple { background: #6c5ce7; }
        .btn-green { background: #2ecc71; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #edf2f7; padding: 8px 4px; text-align: center; min-width: 35px; }
        th { background: #f7fafc; color: #4a5568; position: sticky; top: 0; }
        .shop-col { position: sticky; left: 0; background: #fff; z-index: 5; font-weight: bold; border-right: 2px solid #3498db; }
        .cell-error { background-color: #fff1f0 !important; color: #cf1322 !important; font-weight: bold; border: 1px solid #ffa39e !important; }
        .text-error { color: #cf1322 !important; font-weight: bold; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .view-section { display: none; }
        .view-section.active { display: block; }
        .pagination { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><p id="loading-text">å¤„ç†ä¸­...</p></div>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" id="tab-audit-btn" onclick="switchTab('audit')">ğŸ” è‡ªåŠ¨åŒ–å®¡è®¡æ–¹æ¡ˆ</button>
        <button class="tab-btn" id="tab-manage-btn" onclick="switchTab('manage')">âš™ï¸ åº•æ¿ç®¡ç†å½•å…¥</button>
    </div>

    <div id="page-audit">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="ym" value="2024-03" style="width:100px">
            <button class="btn btn-red" onclick="startAudit()">ğŸš€ å¼€å§‹è‡ªåŠ¨å®¡è®¡</button>
            <button class="btn btn-orange" onclick="startDetailView()">ğŸ“‹ åŸå§‹æ˜ç»†è¡¨</button>
            <div style="border-left: 2px solid #ddd; height: 25px; margin: 0 10px;"></div>
            <button class="btn btn-blue" onclick="switchAuditView('matrix')">çœ‹æ¿å¤§è¡¨</button>
            <button class="btn btn-purple" onclick="switchAuditView('summary')">å…¨é‡åˆ—è¡¨</button>
            <button class="btn btn-red" onclick="switchAuditView('exception')" style="background:#ff4d4f">ğŸ”´ å¼‚å¸¸æ•´æ”¹æ¸…å•</button>
            <div style="flex-grow: 1;"></div>
            <input type="file" id="csv-file">
            <button class="btn btn-green" onclick="uploadCsv()">ğŸ“¥ å¯¼å…¥ CSVæ•°æ®</button>
        </div>

        <div id="view-matrix" class="view-section active" style="overflow: auto; max-height: 70vh;"></div>
        <div id="view-summary" class="view-section" style="overflow: auto; max-height: 70vh;"></div>
        <div id="view-exception" class="view-section" style="overflow: auto; max-height: 70vh;"></div>

        <div class="pagination" id="pager" style="display:none;">
            <button class="btn btn-blue" onclick="pageNav(-1)">ä¸Šä¸€é¡µ</button>
            <span id="page-info"></span>
            <button class="btn btn-blue" onclick="pageNav(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div id="page-manage" style="display:none;">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="m_ym" value="2024-03" onchange="loadTemplateList()">
            <button class="btn btn-blue" onclick="initNewTemplate()">+ å½•å…¥æ–°åº•æ¿</button>
        </div>

        <div id="template-list-container"></div>

        <div id="editor-panel" style="display:none; border:2px solid #3498db; padding:20px; border-radius:8px; margin-top:10px; background:#fdfdfd;">
            <h3 id="editor-title">åº•æ¿å½•å…¥/ç¼–è¾‘</h3>
            <input type="hidden" id="edit-t-id">
            åº•æ¿å…¨ç§°: <input type="text" id="t_name" placeholder="ä¾‹å¦‚ï¼š135é…é€æ¨¡æ¿A" style="width:200px; padding:5px;">
            <p style="color:#666; font-size:12px; margin:10px 0;">è¯·å‹¾é€‰é…é€æ—¥ï¼ˆ1ä¸ºæœ‰é…é€ï¼Œ0ä¸ºæ— é…é€ï¼‰ï¼š</p>
            <div id="day-inputs" style="display:grid; grid-template-columns: repeat(11, 1fr); gap:10px; margin:15px 0;"></div>
            <button class="btn btn-blue" onclick="submitTemplate()">ç¡®è®¤ä¿å­˜</button>
            <button class="btn btn-red" onclick="document.getElementById('editor-panel').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8181/api/status';
    let currentPage = 1, totalPages = 1, currentMode = 'audit';

    function showLoader(v, t) {
        document.getElementById('loading-overlay').style.display = v ? 'flex' : 'none';
        if(t) document.getElementById('loading-text').innerText = t;
    }

    // --- é¡µé¢/è§†å›¾åˆ‡æ¢é€»è¾‘ ---
    function switchTab(t) {
        document.getElementById('page-audit').style.display = t === 'audit' ? 'block' : 'none';
        document.getElementById('page-manage').style.display = t === 'manage' ? 'block' : 'none';
        document.getElementById('tab-audit-btn').classList.toggle('active', t === 'audit');
        document.getElementById('tab-manage-btn').classList.toggle('active', t === 'manage');
        if(t === 'manage') loadTemplateList();
    }

    function switchAuditView(viewId) {
        document.querySelectorAll('.view-section').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewId).classList.add('active');
    }

    // --- å®¡è®¡åŠŸèƒ½é€»è¾‘ ---
    async function startAudit() {
        currentPage = 1; currentMode = 'audit';
        switchAuditView('matrix');
        await loadAuditData();
    }

    async function startDetailView() {
        currentPage = 1; currentMode = 'detail';
        switchAuditView('matrix');
        await loadDetailsData();
    }

    async function loadAuditData() {
        showLoader(true, "æ­£åœ¨æå–å…¨ç»´åº¦å®¡è®¡ç»“æœ...");
        try {
            const res = await fetch(`${API}/auto-report?yearMonth=${document.getElementById('ym').value}&current=${currentPage}`);
            const data = await res.json();
            // æ¸²æŸ“å¤§è¡¨
            let mHtml = '<table><thead><tr><th class="shop-col">é—¨åº—ID</th><th>å»ºè®®åº•æ¿</th>';
            for(let d=1; d<=data.days; d++) mHtml += `<th>${d<10?'0'+d:d}</th>`;
            mHtml += '</tr></thead><tbody>';
            (data.records||[]).forEach(row => {
                mHtml += `<tr><td class="shop-col">${row.shopId}</td><td style="color:#e67e22">${row.bestTemplate}</td>`;
                for(let d=1; d<=data.days; d++) mHtml += `<td class="${row['isError'+d]?'cell-error':''}">${row['day'+d]}</td>`;
                mHtml += '</tr>';
            });
            document.getElementById('view-matrix').innerHTML = mHtml + '</tbody></table>';
            // æ¸²æŸ“å…¨é‡
            let sHtml = '<table><thead><tr><th>é—¨åº— ID</th><th>æ—¥æœŸ</th><th>çŠ¶æ€</th></tr></thead><tbody>';
            (data.auditSummary||[]).forEach(i => sHtml += `<tr><td>${i.shopId}</td><td>${i.date}</td><td class="${i.isError?'text-error':''}">${i.status}</td></tr>`);
            document.getElementById('view-summary').innerHTML = sHtml + '</tbody></table>';
            // æ¸²æŸ“å¼‚å¸¸
            let eHtml = '<table><thead><tr><th>å¼‚å¸¸é—¨åº—</th><th>æ—¥æœŸ</th></tr></thead><tbody>';
            if(data.exceptionList && data.exceptionList.length > 0) {
                data.exceptionList.forEach(i => eHtml += `<tr><td>${i.shopId}</td><td>${i.date}</td></tr>`);
            } else { eHtml += '<tr><td colspan="2">æš‚æ— å¼‚å¸¸æ•°æ®</td></tr>'; }
            document.getElementById('view-exception').innerHTML = eHtml + '</tbody></table>';
            totalPages = data.pages; updatePager(data);
        } catch (e) { console.warn("å®¡è®¡åŠ è½½ä¸­æ–­", e); }
        showLoader(false);
    }

    async function loadDetailsData() {
        showLoader(true, "æ­£åœ¨è·å–åŸå§‹æ•°æ®æ˜ç»†...");
        try {
            const res = await fetch(`${API}/details?yearMonth=${document.getElementById('ym').value}&current=${currentPage}`);
            const data = await res.json();
            let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>é—¨åº—ID</th><th>SKU</th><th>æ•°é‡</th></tr></thead><tbody>';
            (data.records||[]).forEach(r => html += `<tr><td>${r.date}</td><td>${r.shopId}</td><td>${r.skuId}</td><td>${r.qty}</td></tr>`);
            document.getElementById('view-matrix').innerHTML = html + '</tbody></table>';
            totalPages = data.pages; updatePager(data);
        } catch (e) { console.warn("æ˜ç»†åŠ è½½ä¸­æ–­", e); }
        showLoader(false);
    }

    function updatePager(d) {
        document.getElementById('pager').style.display = 'flex';
        document.getElementById('page-info').innerText = `ç¬¬ ${d.current} / ${d.pages} é¡µ`;
    }

    function pageNav(s) {
        if(currentPage + s >= 1 && currentPage + s <= totalPages) {
            currentPage += s;
            currentMode === 'detail' ? loadDetailsData() : loadAuditData();
        }
    }

    // --- åº•æ¿ç®¡ç†é€»è¾‘ ---
    async function loadTemplateList() {
        const res = await fetch(`${API}/templates?yearMonth=${document.getElementById('m_ym').value}`);
        const list = await res.json();
        let html = '<table><thead><tr><th>æ ‡è¯†</th><th>åº•æ¿å…¨ç§°</th><th>æœˆä»½</th><th>æ“ä½œ</th></tr></thead><tbody>';
        list.forEach(t => {
            html += `<tr>
                <td><strong>${t.templateName.substring(0,1)}</strong></td>
                <td>${t.templateName}</td>
                <td>${t.yearMonth}</td>
                <td>
                    <button class="btn btn-blue" style="padding:4px 8px; font-size:10px;" onclick='editTemplate(${JSON.stringify(t)})'>ç¼–è¾‘</button>
                    <button class="btn btn-red" style="padding:4px 8px; font-size:10px;" onclick="deleteTemplate(${t.id})">åˆ é™¤</button>
                </td>
            </tr>`;
        });
        document.getElementById('template-list-container').innerHTML = html + '</tbody></table>';
    }

    function initNewTemplate() {
        document.getElementById('editor-panel').style.display = 'block';
        document.getElementById('editor-title').innerText = "æ–°å»ºåº•æ¿";
        document.getElementById('edit-t-id').value = '';
        document.getElementById('t_name').value = '';
        renderDayInputs();
    }

    function editTemplate(t) {
        document.getElementById('editor-panel').style.display = 'block';
        document.getElementById('editor-title').innerText = "ç¼–è¾‘åº•æ¿ï¼š" + t.templateName;
        document.getElementById('edit-t-id').value = t.id;
        document.getElementById('t_name').value = t.templateName;
        renderDayInputs(t.config.split(','));
    }

    function renderDayInputs(config = null) {
        let html = '';
        for (let i = 1; i <= 31; i++) {
            let val = config ? config[i-1] : '0';
            html += `<div style="text-align:center;">${i}<br><input type="text" class="day-val" style="width:25px; text-align:center;" value="${val}"></div>`;
        }
        document.getElementById('day-inputs').innerHTML = html;
    }

    async function submitTemplate() {
        const body = {
            id: document.getElementById('edit-t-id').value || null,
            templateName: document.getElementById('t_name').value,
            yearMonth: document.getElementById('m_ym').value,
            config: Array.from(document.querySelectorAll('.day-val')).map(i => i.value).join(',')
        };
        await fetch(`${API}/template`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });
        document.getElementById('editor-panel').style.display = 'none';
        loadTemplateList();
    }

    async function deleteTemplate(id) {
        if (confirm("ç¡®å®šåˆ é™¤è¯¥åº•æ¿æ¨¡æ¿å—ï¼Ÿ")) {
            await fetch(`${API}/template/${id}`, { method: 'DELETE' });
            loadTemplateList();
        }
    }

    // --- CSVä¸Šä¼  ---
    async function uploadCsv() {
        const fileInput = document.getElementById('csv-file');
        if(!fileInput.files[0]) return alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶");
        showLoader(true, "æ­£åœ¨ä¸Šä¼ å¹¶æ¸…æ´—æ•°æ®...");
        const fd = new FormData();
        fd.append("file", fileInput.files[0]);
        fd.append("yearMonth", document.getElementById('ym').value);
        try {
            const res = await fetch(`${API}/upload-csv`, { method: 'POST', body: fd });
            const r = await res.json();
            alert("ä¸Šä¼ æˆåŠŸï¼Œå·²è‡ªåŠ¨å…³è”åº•æ¿");
            startAudit();
        } catch (e) { console.error(e); }
        showLoader(false);
    }

    window.onload = () => { startAudit(); };
</script>
</body>
</html>