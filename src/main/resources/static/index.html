<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è€ä¹¡é¸¡é…é€å®¡è®¡çœ‹æ¿ - å·®å¼‚åŒ–å®¡è®¡ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f7f9; color: #333; }
        .card { background: #fff; padding: 25px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 1550px;}
        .tabs { display: flex; gap: 15px; margin-bottom: 25px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 12px 25px; cursor: pointer; border: none; background: none; font-size: 16px; font-weight: bold; color: #7f8c8d; transition: 0.3s; }
        .tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
        .toolbar { display: flex; gap: 12px; margin-bottom: 20px; align-items: center; background: #f8f9fa; padding: 18px; border-radius: 8px; flex-wrap: wrap; }
        .btn { padding: 9px 18px; cursor: pointer; border: none; border-radius: 5px; color: #fff; font-weight: bold; transition: all 0.2s; }
        .btn:active { transform: scale(0.95); }
        .btn-blue { background: #3498db; }
        .btn-green { background: #2ecc71; }
        .btn-red { background: #e74c3c; }
        .btn-orange { background: #e67e22; }
        table { width: 100%; border-collapse: collapse; background: #fff; margin-bottom: 20px; }
        th, td { border: 1px solid #edf2f7; padding: 12px; text-align: center; }
        th { background: #f7fafc; color: #4a5568; font-size: 14px; position: sticky; top: 0; z-index: 10; }
        tr:hover { background-color: #f1f7ff; }
        .cell-error { background-color: #fff1f0 !important; color: #cf1322 !important; font-weight: bold !important; border: 2px solid #ffa39e !important; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.7); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .editor-panel { display: none; background: #fff; border: 2px solid #3498db; padding: 20px; border-radius: 8px; margin-top: 15px; }
        .day-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)); gap: 10px; margin: 20px 0; }
        .day-item { background: #f1f7ff; padding: 8px; border-radius: 4px; border: 1px solid #d1e3ff; text-align: center; }
        .day-item input { width: 40px; text-align: center; }
        .pagination { margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center; }
    </style>
</head>
<body>

<div id="loading-overlay">
    <div class="spinner"></div>
    <p id="loading-text">ğŸ“¡ æ­£åœ¨å¤„ç†ä¸­...</p>
</div>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" id="tab-audit-btn" onclick="switchTab('audit')">ğŸ” è‡ªåŠ¨å®¡è®¡çœ‹æ¿</button>
        <button class="tab-btn" id="tab-manage-btn" onclick="switchTab('manage')">âš™ï¸ åº•æ¿ç®¡ç†å½•å…¥</button>
    </div>

    <div id="page-audit">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="ym" value="2024-03" style="width:105px">
            <button class="btn btn-red" onclick="startAudit()">ğŸš€ å¼€å§‹è‡ªåŠ¨å®¡è®¡</button>
            <button class="btn btn-orange" onclick="startDetailView()">ğŸ“‹ åŸå§‹æ˜ç»†è¡¨</button>
            <div style="flex-grow: 1;"></div>
            <input type="file" id="csv-file">
            <button class="btn btn-green" onclick="uploadCsv()">ğŸ“¥ å¯¼å…¥ CSV</button>
        </div>
        <div id="display-area" style="overflow: auto; max-height: 600px; border: 1px solid #eee;">
            <p style="text-align:center; color:#999; padding:50px;">è¯·ç‚¹å‡»æŒ‰é’®å¼€å§‹â€œå·®å¼‚æå–â€å®¡è®¡</p>
        </div>
        <div class="pagination" id="pager" style="display:none; text-align:center; margin-top:15px;">
            <button class="btn btn-blue" onclick="pageNav(-1)">ä¸Šä¸€é¡µ</button>
            <span id="page-info" style="margin: 0 15px;"></span>
            <button class="btn btn-blue" onclick="pageNav(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div id="page-manage" style="display:none;">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="m_ym" value="2024-03" onchange="loadTemplateList()">
            <button class="btn btn-blue" onclick="initNewTemplate()">+ å½•å…¥æ–°é…é€åº•æ¿</button>
        </div>
        <div id="template-list-container"></div>
        <div id="editor-panel" class="editor-panel">
            <h3 id="editor-title">åº•æ¿å½•å…¥/ç¼–è¾‘</h3>
            <input type="hidden" id="edit-t-id">
            åç§°: <input type="text" id="t_name" style="width:250px" placeholder="ä¾‹å¦‚ï¼šä¸‰æœˆéš”å¤©é…é€æ¨¡æ¿">
            <div id="day-inputs" class="day-grid"></div>
            <div style="text-align:right;">
                <button class="btn btn-green" onclick="submitTemplate()">ä¿å­˜åº•æ¿</button>
                <button class="btn btn-red" onclick="hideEditor()">å–æ¶ˆ</button>
            </div>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8181/api/status';
    let currentPage = 1, totalPages = 1, currentView = 'audit';

    // æ”¹è¿›çš„ loaderï¼Œæ”¯æŒä¼ å…¥è‡ªå®šä¹‰æç¤ºè¯
    function showLoader(visible, text) {
        document.getElementById('loading-overlay').style.display = visible ? 'flex' : 'none';
        if(text) document.getElementById('loading-text').innerText = text;
    }

    function switchTab(t) {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(`tab-${t}-btn`).classList.add('active');
        document.getElementById('page-audit').style.display = t === 'audit' ? 'block' : 'none';
        document.getElementById('page-manage').style.display = t === 'manage' ? 'block' : 'none';
        if(t === 'manage') loadTemplateList();
    }

    async function startAudit() { currentView = 'audit'; currentPage = 1; await loadAuditData(); }
    async function startDetailView() { currentView = 'details'; currentPage = 1; await loadDetailsData(); }

    async function loadAuditData() {
        showLoader(true, "ğŸ” æ­£åœ¨æå–è¿è§„è„æ•°æ®...");
        const ym = document.getElementById('ym').value;
        try {
            const res = await fetch(`${API}/auto-report?yearMonth=${ym}&current=${currentPage}`);
            const data = await res.json();
            const shops = data.shopList || [], bests = data.bestTemplates || {};

            let html = '<table><thead><tr><th>é—¨åº— ID</th>' + shops.map(s => `<th>${s}</th>`).join('') + '</tr>';
            html += '<tr><th>å»ºè®®åº•æ¿</th>' + shops.map(s => `<th style="color:#d46b08; background:#fff7e6; font-size:12px;">${bests[s] || '-'}</th>`).join('') + '</tr></thead><tbody>';

            data.records.forEach(row => {
                html += `<tr><td><strong>${row.Date}</strong></td>`;
                shops.forEach(sid => {
                    const val = row[sid]; // åç«¯å·²ç»å¤„ç†å¥½äº†å·®å¼‚ï¼Œè¿™é‡Œç›´æ¥å–
                    const isDiff = (val !== "-");
                    html += `<td class="${isDiff ? 'cell-error' : ''}">${val}</td>`;
                });
                html += '</tr>';
            });
            document.getElementById('display-area').innerHTML = html + '</tbody></table>';
            totalPages = data.pages; updatePager(data);
        } finally { showLoader(false); }
    }

    async function loadDetailsData() {
        showLoader(true, "ğŸ“‹ æ­£åœ¨æŸ¥çœ‹åŸå§‹æ•°æ®æ˜ç»†...");
        const ym = document.getElementById('ym').value;
        try {
            const res = await fetch(`${API}/details?yearMonth=${ym}&current=${currentPage}`);
            const data = await res.json();
            let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>é—¨åº— ID</th><th>SKU</th><th>æ•°é‡</th></tr></thead><tbody>';
            (data.records || []).forEach(d => {
                html += `<tr><td>${d.date}</td><td>${d.shopId}</td><td>${d.skuId}</td><td>${d.qty}</td></tr>`;
            });
            document.getElementById('display-area').innerHTML = html + '</tbody></table>';
            totalPages = data.pages; updatePager(data);
        } finally { showLoader(false); }
    }

    function updatePager(data) {
        document.getElementById('pager').style.display = 'block';
        document.getElementById('page-info').innerText = `ç¬¬ ${data.current} / ${data.pages} é¡µ`;
    }

    function pageNav(s) {
        if(currentPage+s >=1 && currentPage+s <= totalPages) {
            currentPage += s;
            if(currentView === 'audit') loadAuditData();
            else loadDetailsData();
        }
    }

    async function loadTemplateList() {
        showLoader(true, "âš™ï¸ æ­£åœ¨è·å–åº•æ¿åˆ—è¡¨...");
        const ym = document.getElementById('m_ym').value;
        try {
            const res = await fetch(`${API}/templates?yearMonth=${ym}`);
            const list = await res.json();
            let html = '<table><tr><th>åº•æ¿åç§°</th><th>æœˆä»½</th><th>åºåˆ—é¢„è§ˆ</th><th>æ“ä½œ</th></tr>';
            list.forEach(t => {
                html += `<tr><td><strong>${t.templateName}</strong></td><td>${t.yearMonth}</td>
                    <td style="font-size:10px; color:#999;">${t.config.substring(0,30)}...</td>
                    <td><button class="btn btn-blue" style="padding:4px 8px" onclick='editTemplate(${JSON.stringify(t)})'>ç¼–è¾‘</button>
                        <button class="btn btn-red" style="padding:4px 8px" onclick="deleteTemplate(${t.id})">åˆ é™¤</button></td></tr>`;
            });
            document.getElementById('template-list-container').innerHTML = html + (list.length ? '' : '<tr><td colspan="4">æš‚æ— åº•æ¿</td></tr>') + '</table>';
        } finally { showLoader(false); }
    }

    function editTemplate(t) {
        document.getElementById('editor-panel').style.display = 'block';
        document.getElementById('edit-t-id').value = t.id;
        document.getElementById('t_name').value = t.templateName;
        renderDayInputs(t.config.split(','));
        window.scrollTo(0, document.body.scrollHeight);
    }

    function initNewTemplate() {
        document.getElementById('editor-title').innerText = "æ–°å¢åº•æ¿å½•å…¥";
        document.getElementById('edit-t-id').value = "";
        document.getElementById('t_name').value = "";
        renderDayInputs();
        document.getElementById('editor-panel').style.display = 'block';
    }

    function renderDayInputs(configArray = null) {
        const ym = document.getElementById('m_ym').value;
        const days = new Date(ym.split('-')[0], ym.split('-')[1], 0).getDate();
        let html = '';
        for(let i=1; i<=days; i++) {
            const val = configArray ? configArray[i-1].trim() : "1";
            html += `<div class="day-item">${i}å·<br><input type="text" class="d-val" value="${val}"></div>`;
        }
        document.getElementById('day-inputs').innerHTML = html;
    }

    async function submitTemplate() {
        const id = document.getElementById('edit-t-id').value;
        const body = {
            templateName: document.getElementById('t_name').value,
            yearMonth: document.getElementById('m_ym').value,
            config: Array.from(document.querySelectorAll('.d-val')).map(i => i.value).join(',')
        };
        if(id) body.id = id;
        await fetch(`${API}/template`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(body) });
        alert("âœ… åº•æ¿å·²ä¿å­˜"); hideEditor(); loadTemplateList();
    }

    async function deleteTemplate(id) {
        if(confirm("ç¡®å®šæ°¸ä¹…åˆ é™¤å—ï¼Ÿ")) { await fetch(`${API}/template/${id}`, { method: 'DELETE' }); loadTemplateList(); }
    }
    function hideEditor() { document.getElementById('editor-panel').style.display = 'none'; }

    async function uploadCsv() {
        const file = document.getElementById('csv-file').files[0];
        if(!file) return alert("è¯·é€‰æ‹©æ–‡ä»¶");
        showLoader(true, "ğŸš€ æ­£åœ¨ä¸Šä¼ å¹¶å¤„ç†ç™¾ä¸‡çº§æ˜ç»†æ•°æ®...");
        const fd = new FormData();
        fd.append("file", file); fd.append("yearMonth", document.getElementById('ym').value);
        try {
            const res = await fetch(`${API}/upload-csv`, { method: 'POST', body: fd });
            const result = await res.json();
            if(result.status === 'SUCCESS') { alert("âœ… ç™¾ä¸‡æ•°æ®å¯¼å…¥æˆåŠŸ"); startAudit(); }
        } finally { showLoader(false); }
    }
</script>
</body>
</html>