<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>é…é€ç®¡ç†çœ‹æ¿ç³»ç»Ÿ - äº¿çº§æ•°æ®ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f7f9; color: #333; }
        .card { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); max-width: 1400px; margin: 0 auto; }
        h2 { color: #2c3e50; border-bottom: 2px solid #3498db; padding-bottom: 10px; }

        .toolbar { display: flex; gap: 10px; margin-bottom: 20px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 6px; flex-wrap: wrap; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; color: #fff; font-weight: bold; transition: background 0.3s; }
        .btn-blue { background: #3498db; }
        .btn-blue:hover { background: #2980b9; }
        .btn-green { background: #2ecc71; }
        .btn-green:hover { background: #27ae60; }
        .btn-orange { background: #e67e22; }
        .btn-orange:hover { background: #d35400; }
        .btn-red { background: #e74c3c; }
        .btn-red:hover { background: #c0392b; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; background: #fff; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        th, td { border: 1px solid #eee; padding: 12px; text-align: center; }
        th { background: #f8f9fa; color: #666; position: sticky; top: 0; z-index: 10; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        tr:hover { background-color: #f1f7ff; }

        #loading { display: none; color: #3498db; margin-bottom: 10px; font-weight: bold; animation: blink 1s infinite; }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        .pagination { margin-top: 20px; display: flex; justify-content: center; gap: 15px; align-items: center; }
        .status-val { font-weight: bold; color: #2980b9; font-size: 1.1em; }
        .qty-val { color: #27ae60; font-weight: bold; }
        input[type="text"] { padding: 6px; border: 1px solid #ddd; border-radius: 4px; }
    </style>
</head>
<body>

<div class="card">
    <h2>ğŸšš é…é€ç®¡ç†çœ‹æ¿ (å¤§æ•°æ®ä¼˜åŒ–çš„åˆ†é¡µç‰ˆ)</h2>

    <div class="toolbar">
        æœˆä»½ï¼š<input type="text" id="ym" value="2024-03" placeholder="YYYY-MM">

        <button class="btn btn-blue" onclick="changeView('status-report')">é—¨åº—çŠ¶æ€è¡¨</button>
        <button class="btn btn-red" onclick="changeView('exception-report')">å¼‚å¸¸é—¨åº—æ¸…å•</button>
        <button class="btn btn-orange" onclick="changeView('details')">åŸå§‹æ˜ç»†è¡¨</button>

        <div style="flex-grow: 1;"></div>

        <input type="file" id="csv" accept=".csv">
        <button class="btn btn-green" onclick="upload()">å¯¼å…¥ CSV æ•°æ®</button>
    </div>

    <div id="loading">ğŸ“¡ ç³»ç»Ÿå¤„ç†ä¸­ï¼Œè¯·ç¨å€™...</div>

    <div id="view" style="max-height: 600px; overflow: auto; border: 1px solid #eee;">
        <p style="text-align: center; color: #999; padding: 40px;">è¯·ç‚¹å‡»ä¸Šæ–¹æŒ‰é’®åŠ è½½æ•°æ®</p>
    </div>

    <div class="pagination" id="pager" style="display:none;">
        <button class="btn btn-blue" id="btnPrev" onclick="movePage(-1)">ä¸Šä¸€é¡µ</button>
        <span id="pageInfo">ç¬¬ 1 é¡µ</span>
        <button class="btn btn-blue" id="btnNext" onclick="movePage(1)">ä¸‹ä¸€é¡µ</button>
    </div>
</div>

<script>
    const API = 'http://localhost:8181/api/status';
    let currentView = 'status-report';
    let currentPage = 1;
    let totalPages = 1;

    // åˆ‡æ¢æŠ¥è¡¨è§†å›¾
    function changeView(v) {
        currentView = v;
        currentPage = 1;
        loadData();
    }

    // åˆ†é¡µè·³è½¬é€»è¾‘
    function movePage(step) {
        let next = currentPage + step;
        if (next < 1 || next > totalPages) return;
        currentPage = next;
        loadData();
    }

    // æ ¸å¿ƒæ•°æ®æŸ¥è¯¢å‡½æ•°
    async function loadData() {
        const ym = document.getElementById('ym').value;
        const loading = document.getElementById('loading');
        const view = document.getElementById('view');

        if(!ym) return alert("è¯·è¾“å…¥æŸ¥è¯¢æœˆä»½");
        loading.style.display = 'block';

        try {
            // åç«¯åˆ†é¡µæ‹¦æˆªå™¨ç”Ÿæ•ˆåï¼Œåªä¼šè¿”å› 50 æ¡æ•°æ®ï¼Œä¸ä¼šå¡æ­»
            const res = await fetch(`${API}/${currentView}?yearMonth=${ym}&current=${currentPage}`);
            const result = await res.json();

            // é’ˆå¯¹ MyBatis-Plus çš„ IPage ç»“æ„è¿›è¡Œå®¹é”™å¤„ç†
            // æ³¨æ„ï¼šå¼‚å¸¸é—¨åº—æŠ¥è¡¨è¿”å›çš„æ˜¯ Mapï¼Œç»“æ„ç•¥æœ‰ä¸åŒ
            const records = result.records || result.data || [];
            totalPages = result.pages || 1;

            let html = '<table><thead>';

            if (currentView === 'status-report') {
                html += '<tr><th>é—¨åº— ID</th><th>æ—¥æœŸ</th><th>åˆ¤å®šçŠ¶æ€</th></tr></thead><tbody>';
                records.forEach(row => {
                    html += `<tr><td>${row.shopId}</td><td>${row.date}</td><td class="status-val">${row.status}</td></tr>`;
                });

            } else if (currentView === 'exception-report') {
                html += '<tr><th>æ—¥æœŸ (Date)</th>';
                const shops = result.shopList || [];
                shops.forEach(sid => html += `<th>${sid}</th>`);
                html += '</tr></thead><tbody>';

                records.forEach(row => {
                    html += `<tr><td>${row.Date}</td>`;
                    shops.forEach(sid => {
                        const val = row[sid] || 0;
                        html += `<td>${val > 0 ? '<span class="qty-val">'+val+'</span>' : 0}</td>`;
                    });
                    html += '</tr>';
                });

            } else {
                // åŸå§‹æ˜ç»†è¡¨ (é‡ç‚¹ä¿®æ­£åˆ—åå¤§å°å†™åŒ¹é…)
                html += '<tr><th>æ—¥æœŸ</th><th>é—¨åº—</th><th>SKU</th><th>æ•°é‡</th></tr></thead><tbody>';
                records.forEach(d => {
                    html += `<tr><td>${d.date}</td><td>${d.shopId}</td><td>${d.skuId}</td><td>${d.qty}</td></tr>`;
                });
            }

            view.innerHTML = html + '</tbody></table>';
            updatePager(result);

        } catch(e) {
            console.error(e);
            view.innerHTML = `<p style="color:red; text-align:center;">æ•°æ®åŠ è½½å¼‚å¸¸ï¼Œè¯·æ£€æŸ¥æ‹¦æˆªå™¨é…ç½®: ${e.message}</p>`;
        } finally {
            loading.style.display = 'none';
        }
    }

    // æ›´æ–°åˆ†é¡µæ§ä»¶çŠ¶æ€
    function updatePager(res) {
        document.getElementById('pager').style.display = 'flex';
        const total = res.total || 0;
        const pages = res.pages || 1;
        const current = res.current || 1;

        document.getElementById('pageInfo').innerText = `ç¬¬ ${current} / ${pages} é¡µ (å…± ${total} æ¡æ˜ç»†)`;

        // æŒ‰é’®çŠ¶æ€æ§åˆ¶
        document.getElementById('btnPrev').disabled = (current <= 1);
        document.getElementById('btnNext').disabled = (current >= pages);
        document.getElementById('btnPrev').style.opacity = (current <= 1) ? "0.5" : "1";
        document.getElementById('btnNext').style.opacity = (current >= pages) ? "0.5" : "1";
    }

    // ä¸Šä¼  CSVï¼šä¿®æ­£å‚æ•°åå¹¶å¢åŠ è¿›åº¦æ„Ÿ
    async function upload() {
        const fileInput = document.getElementById('csv');
        const file = fileInput.files[0];
        const ym = document.getElementById('ym').value;

        if(!file) return alert("è¯·å…ˆé€‰æ‹© CSV æ–‡ä»¶");
        if(!ym) return alert("è¯·æŒ‡å®šå¯¼å…¥æœˆä»½");

        const fd = new FormData();
        fd.append("file", file);
        fd.append("yearMonth", ym);

        const loading = document.getElementById('loading');
        loading.innerText = "ğŸš€ æ­£åœ¨å¤„ç†ç™¾ä¸‡çº§æ•°æ®å…¥åº“ï¼Œè¯·å‹¿åˆ·æ–°é¡µé¢...";
        loading.style.display = 'block';

        try {
            const res = await fetch(`${API}/upload-csv`, { method: 'POST', body: fd });
            const resultText = await res.text();

            if (resultText.includes("SUCCESS")) {
                alert("å¯¼å…¥æˆåŠŸï¼100ä¸‡çº§æ•°æ®å·²åŒæ­¥è‡³æ•°æ®åº“å¹¶è‡ªåŠ¨åˆ†é…UUIDæ‰¹æ¬¡ã€‚");
                fileInput.value = ""; // æ¸…ç©ºæ–‡ä»¶é€‰æ‹©
                changeView('details'); // è‡ªåŠ¨è·³è½¬åˆ°æ˜ç»†è¡¨æŸ¥çœ‹
            } else {
                alert("å¤±è´¥: " + resultText);
            }
        } catch (e) {
            alert("ä¸Šä¼ ä¸­æ–­ï¼Œè¯·æ£€æŸ¥æ•°æ®åº“ batch_no å­—æ®µæ˜¯å¦å­˜åœ¨");
        } finally {
            loading.innerText = "ğŸ“¡ ç³»ç»Ÿå¤„ç†ä¸­ï¼Œè¯·ç¨å€™...";
            loading.style.display = 'none';
        }
    }
</script>

</body>
</html>