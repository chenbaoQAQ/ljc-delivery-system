<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>è€ä¹¡é¸¡é…é€å®¡è®¡çœ‹æ¿ - å…¨é‡åŒè§†å›¾ç‰ˆ</title>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; padding: 20px; background: #f4f7f9; }
        .card { background: #fff; padding: 20px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); margin: 0 auto; max-width: 100%; overflow-x: auto;}
        .tabs { display: flex; gap: 15px; margin-bottom: 20px; border-bottom: 2px solid #eee; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: none; font-weight: bold; color: #7f8c8d; }
        .tab-btn.active { color: #3498db; border-bottom: 3px solid #3498db; }
        .toolbar { display: flex; gap: 12px; margin-bottom: 15px; align-items: center; background: #f8f9fa; padding: 15px; border-radius: 8px; }
        .btn { padding: 8px 16px; cursor: pointer; border: none; border-radius: 4px; color: #fff; font-weight: bold; }
        .btn-blue { background: #3498db; }
        .btn-red { background: #e74c3c; }
        .btn-orange { background: #e67e22; }
        .btn-toggle { background: #6c5ce7; margin-left: 10px; }
        table { width: 100%; border-collapse: collapse; font-size: 12px; margin-top: 10px; }
        th, td { border: 1px solid #edf2f7; padding: 8px 4px; text-align: center; min-width: 35px; }
        th { background: #f7fafc; color: #4a5568; position: sticky; top: 0; }
        .shop-col { position: sticky; left: 0; background: #fff; z-index: 5; font-weight: bold; border-right: 2px solid #3498db; width: 80px; }
        /* æ ‡çº¢æ ·å¼ */
        .cell-error { background-color: #fff1f0 !important; color: #cf1322 !important; font-weight: bold; border: 1px solid #ffa39e !important; }
        .text-error { color: #cf1322 !important; font-weight: bold; }
        #loading-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; }
        .spinner { width: 40px; height: 40px; border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .pagination { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .view-section { display: none; }
        .view-section.active { display: block; }
    </style>
</head>
<body>

<div id="loading-overlay"><div class="spinner"></div><p id="loading-text">å¤„ç†ä¸­...</p></div>

<div class="card">
    <div class="tabs">
        <button class="tab-btn active" id="tab-audit-btn" onclick="switchTab('audit')">ğŸ” å­—æ¯æ©ç å®¡è®¡çœ‹æ¿</button>
        <button class="tab-btn" id="tab-manage-btn" onclick="switchTab('manage')">âš™ï¸ åº•æ¿ç®¡ç†å½•å…¥</button>
    </div>

    <div id="page-audit">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="ym" value="2024-03" style="width:100px">
            <button class="btn btn-red" onclick="startAudit()">ğŸš€ å¼€å§‹è‡ªåŠ¨å®¡è®¡</button>
            <button class="btn btn-orange" onclick="startDetailView()">ğŸ“‹ åŸå§‹æ˜ç»†è¡¨</button>
            <button class="btn btn-toggle" id="btn-view-toggle" onclick="toggleAuditView()">åˆ‡æ¢åˆ°åˆ—è¡¨æ¨¡å¼</button>
            <div style="flex-grow: 1;"></div>
            <input type="file" id="csv-file">
            <button class="btn btn-blue" style="background:#2ecc71" onclick="uploadCsv()">ğŸ“¥ å¯¼å…¥ CSV</button>
        </div>

        <div id="view-matrix" class="view-section active" style="overflow: auto; max-height: 70vh;">
            <p style="text-align:center; padding:50px; color:#999;">è¯·ç‚¹å‡»â€œå¼€å§‹è‡ªåŠ¨å®¡è®¡â€åŠ è½½æ•°æ®</p>
        </div>

        <div id="view-summary" class="view-section" style="overflow: auto; max-height: 70vh;">
            <p style="text-align:center; padding:50px; color:#999;">å…¨é‡åˆ—è¡¨è§†å›¾</p>
        </div>

        <div class="pagination" id="pager" style="display:none;">
            <button class="btn btn-blue" onclick="pageNav(-1)">ä¸Šä¸€é¡µ</button>
            <span id="page-info"></span>
            <button class="btn btn-blue" onclick="pageNav(1)">ä¸‹ä¸€é¡µ</button>
        </div>
    </div>

    <div id="page-manage" style="display:none;">
        <div class="toolbar">
            æœˆä»½ï¼š<input type="text" id="m_ym" value="2024-03" onchange="loadTemplateList()">
            <button class="btn btn-blue" onclick="initNewTemplate()">+ å½•å…¥æ–°åº•æ¿</button>
        </div>
        <div id="template-list-container"></div>
        <div id="editor-panel" style="display:none; border:2px solid #3498db; padding:20px; border-radius:8px; margin-top:10px; background:#fff;">
            <h3 id="editor-title">åº•æ¿ç¼–è¾‘</h3>
            <input type="hidden" id="edit-t-id">
            åº•æ¿åç§° (é¦–å­—æ¯ä¸ºæ ‡è¯†): <input type="text" id="t_name" placeholder="å¦‚: A-æ­£å¸¸æ¨¡æ¿">
            <div id="day-inputs" style="display:grid; grid-template-columns: repeat(11, 1fr); gap:10px; margin:15px 0;"></div>
            <button class="btn btn-blue" onclick="submitTemplate()">ğŸ’¾ ä¿å­˜å¹¶æ›´æ–°</button>
            <button class="btn btn-red" onclick="document.getElementById('editor-panel').style.display='none'">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script>
    const API = 'http://localhost:8181/api/status';
    let currentPage = 1, totalPages = 1, currentView = 'audit';
    let auditSubView = 'matrix';

    function showLoader(v, t) {
        document.getElementById('loading-overlay').style.display = v ? 'flex' : 'none';
        if(t) document.getElementById('loading-text').innerText = t;
    }

    function switchTab(t) {
        document.getElementById('page-audit').style.display = t === 'audit' ? 'block' : 'none';
        document.getElementById('page-manage').style.display = t === 'manage' ? 'block' : 'none';
        document.getElementById('tab-audit-btn').classList.toggle('active', t === 'audit');
        document.getElementById('tab-manage-btn').classList.toggle('active', t === 'manage');
        if(t === 'manage') loadTemplateList();
    }

    function toggleAuditView() {
        const matrix = document.getElementById('view-matrix');
        const summary = document.getElementById('view-summary');
        const btn = document.getElementById('btn-view-toggle');

        if (auditSubView === 'matrix') {
            auditSubView = 'summary';
            matrix.classList.remove('active');
            summary.classList.add('active');
            btn.innerText = "åˆ‡æ¢åˆ°çœ‹æ¿æ¨¡å¼";
        } else {
            auditSubView = 'matrix';
            matrix.classList.add('active');
            summary.classList.remove('active');
            btn.innerText = "åˆ‡æ¢åˆ°åˆ—è¡¨æ¨¡å¼";
        }
    }

    async function startAudit() { currentView = 'audit'; currentPage = 1; await loadAuditData(); }
    async function startDetailView() { currentView = 'details'; currentPage = 1; await loadDetailsData(); }

    async function loadAuditData() {
        showLoader(true, "æ­£åœ¨ç»„è£…å…¨é‡æ©ç æ•°æ®...");
        const ym = document.getElementById('ym').value;
        const res = await fetch(`${API}/auto-report?yearMonth=${ym}&current=${currentPage}`);
        const data = await res.json();

        // æ¸²æŸ“å¤§è¡¨çœ‹æ¿
        let mHtml = '<table><thead><tr><th class="shop-col">é—¨åº—ID</th><th>å»ºè®®åº•æ¿</th>';
        for(let d=1; d<=data.days; d++) mHtml += `<th>${d<10?'0'+d:d}</th>`;
        mHtml += '</tr></thead><tbody>';
        data.records.forEach(row => {
            mHtml += `<tr><td class="shop-col">${row.shopId}</td><td style="color:#e67e22; font-size:10px">${row.bestTemplate}</td>`;
            for(let d=1; d<=data.days; d++) {
                mHtml += `<td class="${row['isError'+d]?'cell-error':''}">${row['day'+d]}</td>`;
            }
            mHtml += '</tr>';
        });
        document.getElementById('view-matrix').innerHTML = mHtml + '</tbody></table>';

        // æ¸²æŸ“å…¨é‡çºµå‘åˆ—è¡¨
        let sHtml = '<table><thead><tr><th>é—¨åº— ID</th><th>æ—¥æœŸ</th><th>æ©ç çŠ¶æ€(0A/1B)</th></tr></thead><tbody>';
        data.auditSummary.forEach(item => {
            // å¦‚æœ isError ä¸º trueï¼Œç»™è¯¥è¡ŒçŠ¶æ€æ–‡å­—åŠ çº¢
            const errorClass = item.isError ? 'text-error' : '';
            sHtml += `<tr><td>${item.shopId}</td><td>${item.date}</td><td class="${errorClass}">${item.status}</td></tr>`;
        });
        document.getElementById('view-summary').innerHTML = sHtml + '</tbody></table>';

        totalPages = data.pages; updatePager(data); showLoader(false);
    }

    async function loadDetailsData() {
        showLoader(true, "æŸ¥çœ‹åŸå§‹æ˜ç»†...");
        const res = await fetch(`${API}/details?yearMonth=${document.getElementById('ym').value}&current=${currentPage}`);
        const data = await res.json();
        let html = '<table><thead><tr><th>æ—¥æœŸ</th><th>é—¨åº—ID</th><th>SKU</th><th>æ•°é‡</th></tr></thead><tbody>';
        (data.records||[]).forEach(r => html += `<tr><td>${r.date}</td><td>${r.shopId}</td><td>${r.skuId}</td><td>${r.qty}</td></tr>`);
        document.getElementById('view-matrix').innerHTML = html + '</tbody></table>';
        document.getElementById('view-matrix').classList.add('active');
        document.getElementById('view-summary').classList.remove('active');
        totalPages = data.pages; updatePager(data); showLoader(false);
    }

    function updatePager(d) { document.getElementById('pager').style.display = 'flex'; document.getElementById('page-info').innerText = `ç¬¬ ${d.current} / ${d.pages} é¡µ`; }
    function pageNav(s) { if(currentPage+s>=1 && currentPage+s<=totalPages) { currentPage+=s; if(currentView==='audit') loadAuditData(); else loadDetailsData(); } }

    async function loadTemplateList() {
        const res = await fetch(`${API}/templates?yearMonth=${document.getElementById('m_ym').value}`);
        const list = await res.json();
        let html = '<table><tr><th>æ ‡è¯†</th><th>åº•æ¿å…¨ç§°</th><th>æœˆä»½</th><th>æ“ä½œ</th></tr>';
        list.forEach(t => html += `<tr><td><strong>${t.templateName.substring(0,1)}</strong></td><td>${t.templateName}</td><td>${t.yearMonth}</td><td><button onclick='editTemplate(${JSON.stringify(t)})'>ç¼–è¾‘</button> <button onclick="deleteTemplate(${t.id})">åˆ é™¤</button></td></tr>`);
        document.getElementById('template-list-container').innerHTML = html + '</table>';
    }

    function editTemplate(t) { document.getElementById('editor-panel').style.display='block'; document.getElementById('edit-t-id').value=t.id; document.getElementById('t_name').value=t.templateName; renderDayInputs(t.config.split(',')); }
    function initNewTemplate() { document.getElementById('editor-panel').style.display='block'; document.getElementById('edit-t-id').value=''; document.getElementById('t_name').value=''; renderDayInputs(); }
    function renderDayInputs(c=null) { let h=''; for(let i=1; i<=31; i++) h+=`<div>${i}<br><input type="text" class="d-val" style="width:20px" value="${c?c[i-1]:'1'}"></div>`; document.getElementById('day-inputs').innerHTML=h; }

    async function submitTemplate() {
        const body = { id: document.getElementById('edit-t-id').value||null, templateName: document.getElementById('t_name').value, yearMonth: document.getElementById('m_ym').value, config: Array.from(document.querySelectorAll('.d-val')).map(i=>i.value).join(',') };
        await fetch(`${API}/template`, { method:'POST', headers:{'Content-Type':'application/json'}, body:JSON.stringify(body) });
        alert("åº•æ¿å·²æ›´æ–°"); document.getElementById('editor-panel').style.display='none'; loadTemplateList();
    }

    async function deleteTemplate(id) { if(confirm("ç¡®å®šåˆ é™¤ï¼Ÿ")) { await fetch(`${API}/template/${id}`, {method:'DELETE'}); loadTemplateList(); } }

    async function uploadCsv() {
        showLoader(true, "ğŸš€ å¯¼å…¥ä¸­...");
        const fd = new FormData(); fd.append("file", document.getElementById('csv-file').files[0]); fd.append("yearMonth", document.getElementById('ym').value);
        const res = await fetch(`${API}/upload-csv`, { method:'POST', body:fd });
        const r = await res.json();
        if(r.status==='SUCCESS') { alert("æ•°æ®å·²å¯¼å…¥"); startAudit(); } else { alert("å¤±è´¥"); showLoader(false); }
    }
</script>
</body>
</html>